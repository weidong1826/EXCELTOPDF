<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel è½¬ PDF </title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* --- UI ç•Œé¢æ ·å¼ --- */
        :root { --bg-color: #525659; --sidebar-width: 320px; --primary-color: #107c41; /* Excel Green */ }
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; display: flex; height: 100vh; background-color: var(--bg-color); overflow: hidden; }
        
        .sidebar { width: var(--sidebar-width); background: #f8f9fa; padding: 20px; display: flex; flex-direction: column; gap: 15px; box-shadow: 2px 0 10px rgba(0,0,0,0.2); z-index: 100; overflow-y: auto; border-right: 1px solid #ddd; }
        .control-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 13px; font-weight: 600; color: #333; }
        select, input, button { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        
        button.btn-primary { background-color: var(--primary-color); color: white; border: none; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        button.btn-primary:hover { background-color: #0c5e31; }
        
        .slider-container { display: flex; align-items: center; gap: 10px; }
        .slider-value { min-width: 40px; text-align: right; font-weight: bold; color: var(--primary-color); }

        /* --- é¢„è§ˆåŒºåŸŸ --- */
        .preview-area { flex: 1; padding: 40px; overflow: auto; display: flex; justify-content: center; align-items: flex-start; }
        
        /* æ¨¡æ‹Ÿçº¸å¼ å®¹å™¨ */
        #print-container {
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            min-height: 297mm;
            /* å®½åº¦ç”± JS åŠ¨æ€è®¾ç½® */
            box-sizing: border-box;
            /* å…³é”®ï¼šå»æ‰ paddingï¼Œè®© Excel å†…å®¹é¡¶æ ¼æˆ–ç”± CSS margin æ§åˆ¶ */
            padding: 0; 
            transform-origin: top center;
        }

        /* --- è¡¨æ ¼å†…å®¹æ ·å¼ (æ ¸å¿ƒä¼˜åŒ–) --- */
        table { 
            border-collapse: collapse; 
            width: 100%; 
            table-layout: fixed; /* ä¿®å¤é¢„è§ˆä¹±è·‘çš„é—®é¢˜ï¼Œå¼ºåˆ¶åˆ—å®½ */
        }
        
        th, td { 
            border: 1px solid #000; 
            /* å…è®¸æ¢è¡Œ */
            word-wrap: break-word; 
            overflow-wrap: break-word;
            vertical-align: middle;
        }
        
        /* ç´§å‡‘æ¨¡å¼æ ·å¼ (é»˜è®¤) */
        .compact-mode th, .compact-mode td {
            padding: 2px 4px; /* æå°çš„å†…è¾¹è· */
            font-size: 11px;  /* Excel é»˜è®¤å­—ä½“å¤§å°èŒƒå›´ */
            line-height: 1.2;
        }

        /* å®½æ¾æ¨¡å¼ (å¯é€‰) */
        .loose-mode th, .loose-mode td {
            padding: 8px;
            font-size: 14px;
        }

        th { background-color: #f3f3f3; font-weight: bold; text-align: center; }

        /* å…³é”®ï¼šä¿®å¤è¡Œåˆ‡å‰²ï¼Œä½†ä¸å†å¼ºåˆ¶è¡¨å¤´é‡å¤ */
        tr { page-break-inside: avoid; break-inside: avoid; }
        
        /* é»˜è®¤ä¸é‡å¤è¡¨å¤´ï¼Œå¦‚æœéœ€è¦é‡å¤ï¼Œå¯ä»¥åŠ  thead { display: table-header-group }ï¼Œè¿™é‡Œå»æ‰ */
        thead { display: table-row-group; } 

        /* --- æ‰“å°æ—¶çš„æ ·å¼è¦†ç›– --- */
        @media print {
            .sidebar { display: none !important; }
            .preview-area { 
                padding: 0 !important; 
                background: white !important; 
                display: block !important; 
                overflow: visible !important;
            }
            #print-container {
                box-shadow: none !important;
                margin: 0 !important;
                width: 100% !important;
                /* æ‰“å°æ—¶é«˜åº¦è‡ªé€‚åº” */
                min-height: 0 !important; 
            }
            body { background: white; height: auto; overflow: visible; }
        }
    </style>
    <style id="dynamic-style"></style>
</head>
<body>

    <div class="sidebar">
        <h3>Excel è½¬ PDF</h3>
        
        <div class="control-group">
            <label>1. æ–‡ä»¶ä¸å·¥ä½œè¡¨</label>
            <input type="file" id="fileInput" accept=".xlsx, .xls">
            <select id="sheetSelect" disabled style="background:#f0f0f0"></select>
        </div>

        <hr style="border:0; border-top:1px solid #ddd; width:100%">

        <div class="control-group">
            <label>2. çº¸å¼ ä¸å¸ƒå±€</label>
            <select id="pageSize">
                <option value="A4">A4 (210 x 297 mm)</option>
                <option value="A3">A3 (297 x 420 mm)</option>
            </select>
            <select id="orientation">
                <option value="portrait">çºµå‘</option>
                <option value="landscape">æ¨ªå‘</option>
            </select>
        </div>

        <div class="control-group">
            <label>3. ç¼©æ”¾æ¯”ä¾‹ (æ§åˆ¶é¡µæ•°å…³é”®)</label>
            <div class="slider-container">
                <input type="range" id="scaleRange" min="30" max="150" value="85" step="5" style="flex:1">
                <span class="slider-value" id="scaleValue">85%</span>
            </div>
            <div style="font-size:11px; color:#666;">è¶Šå°åˆ™é¡µæ•°è¶Šå°‘ï¼Œç±»ä¼¼äº Excel çš„â€œç¼©æ”¾â€ã€‚</div>
        </div>

        <div class="control-group">
            <label>4. å¯†åº¦è®¾ç½®</label>
            <select id="densityMode">
                <option value="compact">ç´§å‡‘ (Excel é»˜è®¤é£æ ¼)</option>
                <option value="loose">å®½æ¾ (ç½‘é¡µé£æ ¼)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>èŒƒå›´ (å¯é€‰)</label>
            <input type="text" id="rangeInput" placeholder="å¦‚ A1:F50">
        </div>

        <button class="btn-primary" onclick="window.print()">ğŸ–¨ï¸ æ‰“å° / å¦å­˜ä¸º PDF</button>
        <div style="font-size:12px; color:#555; margin-top:5px;">
            <b>æç¤ºï¼š</b> åœ¨æ‰“å°çª—å£ä¸­ï¼š<br>
            1. ç›®æ ‡é€‰æ‹© <b>å¦å­˜ä¸º PDF</b><br>
            2. <b>é¡µè¾¹è·</b> å»ºè®®è®¾ä¸º "æ— " æˆ– "æœ€å°å€¼"<br>
            3. å‹¾é€‰ <b>èƒŒæ™¯å›¾å½¢</b><br>
            4. å°çº¢ä¹¦æœç´¢ï¼šå‘¼å’Œæµ©ç‰¹è‘—åç”¨æˆ· å…è´¹åˆ¶ä½œæ›´å¤šå·¥å…·
        </div>
    </div>

    <div class="preview-area">
        <div id="print-container" class="compact-mode">
            <div style="text-align:center; padding-top:100px; color:#aaa;">
                è¯·ä¸Šä¼ æ–‡ä»¶é¢„è§ˆ
            </div>
        </div>
    </div>

    <script>
        let workbook = null;
        
        const UI = {
            file: document.getElementById('fileInput'),
            sheet: document.getElementById('sheetSelect'),
            container: document.getElementById('print-container'),
            pageSize: document.getElementById('pageSize'),
            orientation: document.getElementById('orientation'),
            scale: document.getElementById('scaleRange'),
            scaleVal: document.getElementById('scaleValue'),
            density: document.getElementById('densityMode'),
            range: document.getElementById('rangeInput'),
            styleTag: document.getElementById('dynamic-style')
        };

        // äº‹ä»¶ç›‘å¬
        UI.file.addEventListener('change', loadFile);
        UI.scale.addEventListener('input', (e) => {
            UI.scaleVal.innerText = e.target.value + '%';
            updateStyles(); // ç¼©æ”¾åªéœ€æ›´æ–° CSS
        });
        
        [UI.sheet, UI.range].forEach(el => el.addEventListener('change', renderTable));
        [UI.pageSize, UI.orientation, UI.density].forEach(el => el.addEventListener('change', updateStyles));

        function loadFile(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const data = new Uint8Array(e.target.result);
                workbook = XLSX.read(data, {type: 'array'});
                UI.sheet.innerHTML = '';
                workbook.SheetNames.forEach(n => {
                    const opt = document.createElement('option');
                    opt.value = opt.textContent = n;
                    UI.sheet.appendChild(opt);
                });
                UI.sheet.disabled = false;
                renderTable();
            };
            reader.readAsArrayBuffer(file);
        }

        function renderTable() {
            if(!workbook) return;
            const ws = workbook.Sheets[UI.sheet.value];
            
            // èŒƒå›´å¤„ç†
            const originalRef = ws['!ref'];
            const userRange = UI.range.value.trim();
            if(userRange) {
                try { XLSX.utils.decode_range(userRange); ws['!ref'] = userRange; } catch(e){}
            }
            
            // ç”Ÿæˆ HTML
            const html = XLSX.utils.sheet_to_html(ws);
            ws['!ref'] = originalRef;
            
            UI.container.innerHTML = html;
            
            // ç®€å•æ¸…ç†ï¼šå»é™¤ SheetJS ç”Ÿæˆçš„å†…è”å®½é«˜ï¼Œè®© CSS æ¥ç®¡
            const table = UI.container.querySelector('table');
            if(table) {
                table.removeAttribute('width');
                table.removeAttribute('height');
                table.style.width = '100%';
            }

            updateStyles();
        }

        function updateStyles() {
            if(!workbook) return;

            // 1. è·å–è®¾ç½®å€¼
            const size = UI.pageSize.value; // A4, A3
            const orient = UI.orientation.value; // portrait
            const scale = parseInt(UI.scale.value) / 100;
            const density = UI.density.value;

            // 2. åˆ‡æ¢å¯†åº¦ Class
            UI.container.className = density === 'compact' ? 'compact-mode' : 'loose-mode';

            // 3. è®¡ç®—ç‰©ç†å®½åº¦ (ç”¨äºé¢„è§ˆåŒºå®¹å™¨å¤§å°)
            const sizesMM = { 'A4': [210, 297], 'A3': [297, 420] };
            let [w, h] = sizesMM[size];
            if(orient === 'landscape') [w, h] = [h, w];
            
            // è¿™é‡Œçš„å®½åº¦æ˜¯â€œæœªç¼©æ”¾å‰â€çš„ç‰©ç†çº¸å¼ å®½åº¦
            // æˆ‘ä»¬é€šè¿‡ zoom å±æ€§æ¥æ§åˆ¶å†…å®¹å¤§å°ï¼Œä½†å®¹å™¨æœ¬èº«éœ€è¦æ¨¡æ‹Ÿçº¸å¼ 
            // ä¸ºäº†è®©é¢„è§ˆå’Œæ‰“å°ä¸€è‡´ï¼Œæˆ‘ä»¬åœ¨ print-container ä¸Šåº”ç”¨ zoom
            
            UI.container.style.width = w + 'mm';
            // Chrome çš„ zoom å±æ€§éå¸¸å¼ºå¤§ï¼Œä¼šçœŸå®åœ°ç¼©æ”¾å¸ƒå±€
            UI.container.style.zoom = scale; 

            // 4. ç”Ÿæˆ @page è§„åˆ™ (æ§åˆ¶æ‰“å°æœºè¡Œä¸º)
            // å¿…é¡»åœ¨ @page ä¸­æ˜ç¡®å‘Šè¯‰æ‰“å°æœºçº¸å¼ å¤§å°
            // margin è®¾ä¸º 0 æˆ–å¾ˆå°ï¼Œè®© HTML å†…å®¹æœ€å¤§åŒ–åˆ©ç”¨çº¸å¼ 
            UI.styleTag.innerHTML = `
                @page {
                    size: ${size} ${orient};
                    margin: 5mm; 
                }
            `;
        }
    </script>
</body>
</html>